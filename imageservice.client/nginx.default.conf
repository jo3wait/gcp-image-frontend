server {
    listen       8080;
    server_name  _;

    # 靜態檔案及 deep‑link 支援
    root   /usr/share/nginx/html;
    index  index.html;
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 代理 /token 到 Metadata Server
    location /token {
        # 只允許內部呼叫（metadata 只能容器內訪問）
        internal;

        # 將 query string 的 audience 參數透過 $arg_audience 帶給 metadata
        proxy_pass       http://metadata/computeMetadata/v1/instance/service-accounts/default/identity?audience=$arg_audience;
        proxy_set_header Metadata-Flavor "Google";

        # 確保不緩存，因為 token 每次都要最新
        add_header   Cache-Control no-store;
    }
}
